= Elasticsearch Connector
:keywords: add_keywords_separated_by_commas
:imagesdir: ./resources/_images
:toc: macro
:toclevels: 2

image:elasticsearch-logo.png[Elasticsearch]

toc::[]

[[overview]]
== Overview

The Elasticsearch connector allows you to access the Elasticsearch REST API through Anypoint Platform. Elasticsearch is a distributed, open source search and analytics engine, designed for horizontal scalability, reliability, and easy management. The connector exposes Elasticsearch operations by executing their API calls as per configuration. It supports HTTP, HTTP with basic authentication and HTTPS connections to Elasticsearch instance.
Read through this user guide to understand how to set up and configure a basic flow using the connector. 

Track features and API version updates using the Elasticsearch connector release notes. Review the connector operations and see how they work by reviewing the technical reference alongside the demo applications.

[[important-concepts]]
== Important Concepts

This document assumes that you are familiar with Elasticsearch,
link:https://docs.mulesoft.com/connectors/[Anypoint Connectors], and
link:https://www.mulesoft.com/platform/studio[Anypoint Studio]. To increase your familiarity with Studio, consider completing a link:https://docs.mulesoft.com/anypoint-studio/v/7.1/[Anypoint Studio Tutorial]. This page requires basic knowledge of link:https://docs.mulesoft.com/mule4-user-guide/v/4.1/[Mule Key Concepts] and link:https://www.elastic.co/[Elasticsearch].

[[requirements]]
== Software Requirements

For software requirements, visit the link:release-notes.adoc[Connector Release Notes].

[[install]]
== How to Install

You can install the connector in Anypoint Studio using the instructions in
link:https://docs.mulesoft.com/anypoint-studio/v/7.1/add-modules-in-studio-to[Installing a Connector from Anypoint Exchange].

Additionally, we recommend you to keep Studio up to date with its latest version.

[[ns-schema]]
== Connector Namespace and Schema

While designing your application in Anypoint Studio, when you drag the connector from the palette onto the Anypoint Studio canvas, studio automatically populates the XML code with the connector *namespace* and *schema location*.
 
*Namespace:* `+http://www.mulesoft.org/schema/mule/elasticsearch+` +
*Schema Location:* `+http://www.mulesoft.org/schema/mule/elasticsearch/current/mule-elasticsearch.xsd+`

[TIP]
If you are manually coding the Mule application in Studio's XML editor or another text editor, define the namespace and schema location in the header of your *Configuration XML*, inside the `<mule>` tag.

[source, xml,linenums]
----
<mule xmlns:elasticsearch="http://www.mulesoft.org/schema/mule/elasticsearch" 
	xmlns:http="http://www.mulesoft.org/schema/mule/http" 
	xmlns="http://www.mulesoft.org/schema/mule/core" 
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" 
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" 
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core 
	http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/elasticsearch http://www.mulesoft.org/schema/mule/elasticsearch/current/mule-elasticsearch.xsd
</mule>
----

*Note:* Use `current` in the schema path. Studio interprets this to the current Mule version.

[[maven]]
== Maven Dependency Information
After you download and install the connector, use the following steps to make the Elasticsearch connector available inside a Mule application for use and to package the application with connector. If you use Anypoint Studio, it will do this automatically for you. + 
For Maven dependency management, include this XML snippet in your `pom.xml` file.

----
		<dependency>
			<groupId>org.mule.extension.elasticsearch</groupId>
			<artifactId>elasticsearch-extension</artifactId>
			<version>1.0.0</version>
			<classifier>mule-plugin</classifier>
		</dependency>
----

[[configure]]
== How to Configure

=== Creating a New Project
To use the Elasticsearch connector in a Mule application project:
[start=1]
. In Anypoint Studio, click *File > New > Project* +
	image:create-new-project.png[Create New Project] +
	Select Mule project from the dialog box +
	image:select-mule-project.png[Mule Project]

. Enter a name for your new project and leave the remaining options with their default values
	image:create-new-project-dialogue-box.png[Create new project dialogue box]
[start=3]

. Click *Finish* to create the project

=== Configuring the Elasticsearch Global Element
Place the connector in your flow as applicable for your use case.
To use the Elasticsearch connector in your Mule application, you must configure a global Elasticsearch element that is used by the Elasticsearch connector. The Elasticsearch connector provides the following global configuration(s).

image:Elasticsearch-connector-configuration.png[Elasticsearch-connector-config]

[[authentication]]
=== Authentication
To access Elasticsearch you have three following possible ways : 

==== 1. NO AUTHENTICATION + 
In NO AUTHENTICATION, you need to provide your Elasticsearch host and port in a global configuration. NO AUTHENTICATION is generally recommended for quick testing. +
For installation and starting Elasticsearch, refer link:++https://www.elastic.co/guide/en/elasticsearch/reference/current/_installation.html++[Installation].

Following parameters are required for *HTTP* configuration:

[%header%autowidth.spread]
|===
|Field |Description
|*Elasticsearch Host* |Elasticsearch host IP or host name to connect
|*Elasticsearch Port* |Port of Elasticsearch
|===

image:Elasticsearch-http-global-element-props.png[Elasticsearch-HTTP-config]

TIP: Default Elasticsearch port is 9200. +

==== 2. BASIC AUTHENTICATION + 
Along with host and port, basic authentication will require two additional fields:
[start=1]
. Username 
[start=2]
. Password

Following parameters are required for *HTTP* configuration with basic authentication:

[%header%autowidth.spread]
|===
|Field |Description
|*Elasticsearch Host* |Enter the Elasticsearch host IP or host name to connect
|*Elasticsearch Port* |Enter the  port of Elasticsearch engine
|*Username* |Username from user credentials
|*Password* |Password from user credentials
|===

image:Elasticsearch-http-basic-element-props.png[Elasticsearch-HTTP--basic-config]

==== 3. CERTIFICATE BASED AUTHENTICATION + 
Implementing CERTIFICATE BASED AUTHENTICATION mechanism involves a few extra steps, but ìs preferred if your Elasticsearch is exposed to external users, as it ensures better security. + 
To make the Elasticsearch run on HTTPS, generate server and client certificates on Elasticsearch host using X-pack. Please refer link:++https://www.elastic.co/guide/en/elasticsearch/reference/current/configuring-tls.html#node-certificates++[Encrypting communications in Elasticseach] for detailed information about running Elasticsearch on HTTPS and generating required certificates. +

* Following parameters are required for *HTTPS* (Certificate Based Authentication):
[%header%autowidth.spread]
|===
|Field |Description
|*Elasticsearch Host* |Enter the Elasticsearch host IP or host name to connect
|*Elasticsearch Port* |Enter the  port of Elasticsearch engine
|*Username* |Username from user credentials
|*Password* |Password from user credentials
|*Type* |Truststore certificate type e.g. *JKS*
|*Path* |Path of Truststore
|*Truststore Password* |Password for the Truststore
|===

image:Elasticsearch-https-global-element-props.png[Elasticsearch-HTTPS-config]

[NOTE]
Access link:++https://www.elastic.co/guide/en/elasticsearch/reference/current/setup-xpack.html++[X-Pack] for detailed information to provide security and many other capabilities. By default, when you install Elasticsearch, X-Pack is also installed.


[[operations]]
=== Understanding the Elasticsearch Connector

The Elasticsearch connector functions within a Mule application. Using the connector, your application can perform several operations that Elasticsearch exposes via their APIs. When building an application that connects with Elasticsearch you don’t have to go through the effort of custom-coding (and securing!) a connection. Rather, you can just drop a connector into your flow, configure a few connection details, then begin application running on Elasticsearch. 

The real value of the Elasticsearch connector is in the way you use it at design-time in conjunction with other functional features available in Mule.

    ** *DataSense* DataSense extracts metadata for Elasticsearch standard response to automatically determine the data type and format that your application must deliver to, or can expect from, Elasticsearch. Mule does the heavy lifting of discovering the type of data you must send to, or be prepared to receive from Elasticsearch.

    ** *Transform Message Component* This component’s integrated scripting language called DataWeave can automatically extract response metadata that you can use to visually map and/or transform to a different data format or structure. Essentially, DataWeave let’s you control the mapping between data types. For example, if you configure a Elasticsearch connector in your application, then drop a Transform Message component after the connector, the component uses DataWeave to gather information that DataSense extracted to pre-populate the input values for mapping. In other words, DataSense makes sure that DataWeave knows the data format and structure it must work with so you don’t have to figure it out manually.


== Common Use Cases

* link:#use-case-1[Elasticsearch as Document store]

* link:#use-case-2[Search for the phrases from particular dataset]



[use-case-1] 
Elasticsearch stores JSON documents. This is an example of a simple document :
----
{
	"speaker": "KING HENRY IV",
	"type": "line",
	"line_id": 7,
	"play_name": "Henry IV",
	"speech_number": 1,
	"line_number": "1.1.4",
	"text_entry": "To be commenced in strands afar remote"
}

----
=== Elasticsearch as a Document Store
* We will use the readily available dataset that can be found at link:++https://www.elastic.co/guide/en/kibana/current/tutorial-load-dataset.html++[the complete works of William Shakespeare] and the Bulk operation of Elasticsearch connector for the usecase
** In Anypoint Studio, click *File > New > Mule Project*, name the project, and click *OK*
** In the search field, type *http* and drag the *HTTP connector* to the canvas
** Click the HTTP connector, click the *green plus* sign to the right of Connector Configuration, and in the next screen add the host as well as port, click *OK*
** In the Palette search for *Elasticsearch* and drag the *Bulk Operation* onto the canvas
** Select the connection configuration with connection as *HTTP connection* and add the host and port of Elasticsearch
** Configure the *Bulk Operation* options like index, type and the input dataset location
** Drag the *logger* onto the canvas and log `#[payload]` to log low level information of the operation
** In the Palette search for *Elasticsearch* and drag the *Get Document* operation onto the canvas
** Configure the *Get Document* operation options like index, type and document id along with other optional parameters
** Drag the *logger* onto the canvas and log `#[payload]` to log low level information of the operation
** After you create the flow, right-click the project and click *Run As > Mule Applciation*
image:documentstore.png[Documentstore-flow]	

*Example Use Case Code :*

Paste this XML code into Anypoint Studio to experiment with the flow described above.
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:elasticsearch="http://www.mulesoft.org/schema/mule/elasticsearch" xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/elasticsearch http://www.mulesoft.org/schema/mule/elasticsearch/current/mule-elasticsearch.xsd">
	<http:listener-config name="HTTP_Listener_config" doc:name="HTTP Listener config" doc:id="109dff29-90fb-4ed0-b474-22487e49ea1d" >
		<http:listener-connection host="0.0.0.0" port="8081" />
	</http:listener-config>
	<elasticsearch:config name="Elasticsearch_Config1" doc:name="Elasticsearch Config" doc:id="fa6c73c9-56e8-45de-a5bd-dc0c4ba211cc" >
		<elasticsearch:http-connection host="${host}" />
	</elasticsearch:config>
	<flow name="bulkoperationFlow" doc:id="6f18edae-31ae-44f8-819a-9cf062a92acc" >
		<http:listener doc:name="Listener" doc:id="7226082d-691d-46ed-b9cf-39a19f0ecf9b" config-ref="HTTP_Listener_config" path="/bulky"/>
		<elasticsearch:bulk-operation doc:name="Dataset Upload" doc:id="2c8400f3-7cb0-4a66-b24d-24c0a6fcdbe2" index="${index}" type="${indexType}" jsonfile="${datasetPath}" config-ref="Elasticsearch_Config1"/>
		<logger level="INFO" doc:name="Log dataset insert response" doc:id="8ff5a4ae-10d0-4c07-94f0-e7e976b4b83e" message="Inserted Dataset #[payload]"/>
		<elasticsearch:get-document doc:name="Get document" doc:id="d3ec0cd4-f1d9-44de-90cf-f4a78cfbdb1f" config-ref="Elasticsearch_Config1" index="${index}" type="${indexType}" documentId="${documentId}"/>
		<logger level="INFO" doc:name="Log the get document details" doc:id="6c9112f9-4216-445a-bdb5-b64f6e6a469e" message="Document Generated #[payload]"/>
	</flow>
</mule>

----
** To visually analyze the datasets, user can also use of link:++https://www.elastic.co/guide/en/kibana/6.2/index.html++[Kibana]

[use-case-2]
=== Search for the phrases from the dataset
* Elasticsearch is preferred when you're doing a lot of text search, where traditional RDBMS databases are not performing really well (poor configuration, acts as a black-box, poor performance). Elasticsearch is highly customizable, extendable through plugins. You can build robust search without much knowledge quite fast.
* Please refer the previous use case to insert the dataset in Elasticsearch using bulk operation if the dataset is not available.
* We will use simple searching of search operation for this use case. Simple searching is among the least resource intensive tasks you can ask of Elasticsearch. 	
* In this use case we will use Query and Fetch search type and common terms query options of Elasticsearch.

** In Anypoint Studio, click *File > New > Mule Project*, name the project, and click *OK*.
** In the search field, type *http* and drag the *HTTP Listener Connector* to the canvas. 
** Click the HTTP connector, click the *green plus* sign to the right of Connector Configuration, and in the next screen add the host as well as port, click *OK*.
** In the Palette, search for *Elasticsearch* and drag the *Search* operation onto the canvas.
** Click the  *green plus* sign to the right of Connector Configuration to select among the HTTP, HTTP with basic authentication or HTTPS configuration.
** Drag the *logger* onto the canvas and log `#[payload]` to log low level information of the operation.
** After you create the flow, right-click the project and click *Run As > Mule Applciation*.

image:search.png[search-flow]

*Example Use Case Code :*

Paste this XML code into Anypoint Studio to experiment with the flow described in the previous section.
----
<flow name="SearchApplication" doc:id="2cfe03f5-4d90-4087-8080-76423fb699b2" >
		<http:listener doc:name="Listener" doc:id="a898a34e-0e8c-4318-96b6-9707e2f7eb28" config-ref="HTTP_Listener_config" path="/search"/>
		<elasticsearch:search doc:name="Search for the phrase" doc:id="87e9f65d-3d9e-4c65-8e1a-ac5777c557cc" config-ref="Elasticsearch_Config1" index="${index}" searchType="QUERY_AND_FETCH">
			<elasticsearch:query-configuration >
				<elasticsearch:common-terms-query fieldName="speaker" queryString="hamlet" />
			</elasticsearch:query-configuration>
		</elasticsearch:search>
		<logger level="INFO" doc:name="Log the response of search operation" doc:id="e9a87422-6755-49f7-80c0-03df96d3bc65" message="#[payload]"/>
	</flow>
----

== Resources

* link:Elasticsearch-connector-release-notes.adoc[Elasticsearch Connector Release Notes].
* link:Elasticsearch-apidoc.html[Elasticsearch API docs].
