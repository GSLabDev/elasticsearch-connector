<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:elasticsearch="http://www.mulesoft.org/schema/mule/elasticsearch"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:munit="http://www.mulesoft.org/schema/mule/munit"
	xmlns:munit-tools="http://www.mulesoft.org/schema/mule/munit-tools"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/munit http://www.mulesoft.org/schema/mule/munit/current/mule-munit.xsd
http://www.mulesoft.org/schema/mule/munit-tools http://www.mulesoft.org/schema/mule/munit-tools/current/mule-munit-tools.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/elasticsearch http://www.mulesoft.org/schema/mule/elasticsearch/current/mule-elasticsearch.xsd">

	<munit:config name="index-operation-test-suite.xml" />
	<configuration-properties doc:name="Configuration properties"
		doc:id="43e43249-8aa9-476f-aa53-66fcfb7eb77c" file="mule-application.properties" />

	<elasticsearch:config name="Elasticsearch_HTTP_Config1"
		doc:name="Elasticsearch Config" doc:id="07349911-a3c3-4468-adfb-92fdec18ea5f">
		<elasticsearch:http-connection host="${elastic.host}"
			port="${elastic.port}" />
	</elasticsearch:config>

	<munit:test name="createIndexWithIndexSettingAndMappingFlowTest"
		description="Test" doc:id="911bfee5-7eb6-4e2c-9bdb-1ccb793cfe62">
		<munit:execution>
			<elasticsearch:create-index doc:name="Index - Create"
				doc:id="710e782b-d8df-4a63-9911-d4f2a623034d" config-ref="Elasticsearch_HTTP_Config1"
				index="create1">

				<elasticsearch:index-configuration
					indexAlias="twitter_alias1" timeoutInSec="5"
					masterNodeTimeoutInSec="5" waitForActiveShards="2" 
					indexMappingsJSONFile="munit/createIndexMapping.json">
					<elasticsearch:index-settings>
						<elasticsearch:index-setting key="index.number_of_shards"
							value="4" />
						<elasticsearch:index-setting key="index.number_of_replicas"
							value="5" />
					</elasticsearch:index-settings>
				</elasticsearch:index-configuration>

			</elasticsearch:create-index>
			<logger level="INFO" doc:name="Logger"
				doc:id="2d615081-9e96-4f2a-9882-aa443d60006e" message="#[payload]" />
			<elasticsearch:delete-index doc:name="Index - Delete"
				doc:id="f36169bc-a45d-4fa9-8041-3a5632fdc31e" config-ref="Elasticsearch_HTTP_Config1"
				index="create1" />
		</munit:execution>
		<munit:validation>
			<munit-tools:assert-that doc:name="Assert that"
				doc:id="6a886161-abdf-40be-97be-a178a08e7263" is="#[MunitTools::notNullValue()]"
				expression="#[payload]" />
		</munit:validation>
	</munit:test>

	<munit:test name="createIndexWithIndexSettingJSONFileFlowTest"
		description="Test" doc:id="2d49e289-4dac-45e1-a55b-2c22737a0d32">
		<munit:execution>
			<elasticsearch:create-index doc:name="Index - Create"
				doc:id="4888a71e-db8a-4bf2-80ff-9ac77b946577" config-ref="Elasticsearch_HTTP_Config1"
				index="create2">
				<elasticsearch:index-configuration
					indexAlias="twitter_alias_new" timeoutInSec="5" 
					masterNodeTimeoutInSec="5" waitForActiveShards="2" 
					indexSettingsJSONFile="munit/createIndexSetting.json">
				</elasticsearch:index-configuration>
			</elasticsearch:create-index>
			<logger level="INFO" doc:name="Logger"
				doc:id="1b4e28ea-cf94-49b3-bebe-81b5b52fad1b" message="#[payload]" />
			<elasticsearch:delete-index doc:name="Index - Delete"
				doc:id="24013230-4dab-40f8-9280-29f07feee142" config-ref="Elasticsearch_HTTP_Config1"
				index="create2" />
		</munit:execution>
		<munit:validation>
			<munit-tools:assert-that doc:name="Assert that"
				doc:id="6de700ee-a2d5-416c-80b5-eecf4f831254" is="#[MunitTools::notNullValue()]"
				expression="#[payload]" />
		</munit:validation>
	</munit:test>

	<munit:test name="createIndexWithSourceJSONFileFlowTest"
		description="Test" doc:id="423b3f1e-38cf-4aa2-b1d0-395269a6667c">
		<munit:execution>
			<elasticsearch:create-index doc:name="Index - Create"
				doc:id="456b84d5-2b7a-4f5f-bd07-a3076c54fccb" config-ref="Elasticsearch_HTTP_Config1"
				index="create3">
				<elasticsearch:index-configuration
					timeoutInSec="5" masterNodeTimeoutInSec="5" waitForActiveShards="2"
					sourceJSONFile="munit/createIndexSource.json">
				</elasticsearch:index-configuration>
			</elasticsearch:create-index>
			<logger level="INFO" doc:name="Logger"
				doc:id="92ddfba1-a43b-4b5a-9b5b-0d4beca4b3c8" message="#[payload]" />
			<elasticsearch:delete-index doc:name="Index - Delete"
				doc:id="357bdb17-f21c-4e0d-b6ae-7873a3f6a778" config-ref="Elasticsearch_HTTP_Config1"
				index="create3" />
		</munit:execution>
		<munit:validation>
			<munit-tools:assert-that doc:name="Assert that"
				doc:id="dd580738-5e80-4662-b5a4-970df024f5aa" is="#[MunitTools::notNullValue()]"
				expression="#[payload]" />
		</munit:validation>
	</munit:test>

	<munit:test name="createAndDeleteIndex" description="Test"
		doc:id="9e3ca102-5255-4b67-b742-d0e2800df08f">
		<munit:execution>
			<elasticsearch:create-index doc:name="Index - Create"
				doc:id="3f65ed99-d709-4d75-9002-d7ced881e28b" config-ref="Elasticsearch_HTTP_Config1"
				index="test">
			</elasticsearch:create-index>
			<logger level="INFO" doc:name="Logger"
				doc:id="75ad576a-7937-43ec-b9eb-da1262ce9f24" message="#[payload]" />
			<elasticsearch:delete-index doc:name="Index - Delete"
				doc:id="25dac5d7-ceea-4211-8157-f4ccf2f9d27e" config-ref="Elasticsearch_HTTP_Config1"
				index="test" timeoutInSec="5" masterNodeTimeoutInSec="6">
				<elasticsearch:indices-opts
					ignoreUnavailable="true" allowNoIndices="true" expandWildcardsOpen="true"
					expandWildcardsClosed="true" allowAliasesToMultipleIndices="true"
					forbidClosedIndices="true" ignoreAliases="true" ignoreThrottled="true" />
			</elasticsearch:delete-index>
			<logger level="INFO" doc:name="Logger"
				doc:id="dcc48043-c405-439e-8e2b-9fab159ba490" message="#[payload]" />
		</munit:execution>
		<munit:validation>
			<munit-tools:assert-that doc:name="Assert that"
				doc:id="cd8fe1ba-dbe6-4107-be79-d89177a17706" is="#[MunitTools::notNullValue()]"
				expression="#[payload]" />
			<munit-tools:assert-that expression="#[payload.acknowledged]"
				is="#[MunitTools::equalTo(true)]" />
		</munit:validation>
	</munit:test>

	<munit:test name="openIndexFlowTest" description="Test"
		doc:id="873979a6-a571-4391-b73f-d8b4b0730d22">
		<munit:execution>
			<elasticsearch:open-index doc:name="Index - Open"
				doc:id="5999b7b7-f510-4d94-ae68-6fe2a9384e71" config-ref="Elasticsearch_HTTP_Config1"
				index="test_index" timeoutInSec="3" masterNodeTimeoutInSec="5"
				waitForActiveShards="1">
				<elasticsearch:indices-opts
					ignoreUnavailable="true" allowNoIndices="true" expandWildcardsOpen="true"
					expandWildcardsClosed="true" allowAliasesToMultipleIndices="true"
					forbidClosedIndices="true" ignoreAliases="true" ignoreThrottled="true" />
			</elasticsearch:open-index>
			<logger level="INFO" doc:name="Logger"
				doc:id="e9aa5034-b9ad-419c-a008-8de6d15a1ce3" message="#[payload]" />
		</munit:execution>
		<munit:validation>
			<munit-tools:assert-that doc:name="Assert that"
				doc:id="43749bd0-c13b-401b-afec-4241f3010c17" is="#[MunitTools::notNullValue()]"
				expression="#[payload]" />
			<munit-tools:assert-that expression="#[payload.acknowledged]"
				is="#[MunitTools::equalTo(true)]" />
		</munit:validation>
	</munit:test>

	<munit:test name="closeIndexFlowTest" description="Test"
		doc:id="ac5945b2-a375-4c2b-bead-d1b8f5d16fe0">
		<munit:execution>
			<elasticsearch:close-index doc:name="Index - Close"
				doc:id="3df98052-dd96-4676-9123-e18f27b6dfcc" config-ref="Elasticsearch_HTTP_Config1"
				index="test_index" timeoutInSec="4" masterNodeTimeoutInSec="5">
				<elasticsearch:indices-opt allowNoIndices="true"
					expandWildcardsOpen="true" expandWildcardsClosed="true"
					allowAliasesToMultipleIndices="true" forbidClosedIndices="true"
					ignoreAliases="true" ignoreThrottled="true" ignoreUnavailable="true" />
			</elasticsearch:close-index>
			<logger level="INFO" doc:name="Logger"
				doc:id="aea2e3f2-54ec-4c03-8686-e44c2b949adb" message="#[payload]" />
		</munit:execution>
		<munit:validation>
			<munit-tools:assert-that doc:name="Assert that"
				doc:id="026c2a70-5dde-466c-9523-98e97608180a" is="#[MunitTools::notNullValue()]"
				expression="#[payload]" />

			<munit-tools:assert-that expression="#[payload.acknowledged]"
				is="#[MunitTools::equalTo(true)]" />

		</munit:validation>
	</munit:test>
	<munit:test name="createIndexWithSourceJSONFileFlowTest2"
        description="Test" doc:id="881ee626-9c3f-42d7-9edf-4a37143ce3bc">
        <munit:execution>
            <elasticsearch:create-index doc:name="Index - Create"
                doc:id="fb5f550e-1b2a-499d-b193-e9cb1a520bb4" config-ref="Elasticsearch_HTTP_Config1"
                index="create3">
                <elasticsearch:index-configuration
                    sourceJSONFile="munit/createIndexSource.json">
                </elasticsearch:index-configuration>
            </elasticsearch:create-index>
            <logger level="INFO" doc:name="Logger"
                doc:id="e6fee52f-1a96-4aee-bc9c-b3cd0cfc173c" message="#[payload]" />
            <elasticsearch:delete-index doc:name="Index - Delete"
                doc:id="9879be59-cc62-47de-96db-beed5914127b" config-ref="Elasticsearch_HTTP_Config1"
                index="create3" />
        </munit:execution>
    </munit:test>
</mule>
